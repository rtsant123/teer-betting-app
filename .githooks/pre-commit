#!/bin/bash
#
# Pre-commit hook to prevent hardcoded localhost URLs
#

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for hardcoded localhost/127.0.0.1 references
echo "🔍 Checking for hardcoded localhost URLs..."

# Files to check (exclude .env* files and this hook)
PATTERNS=(
    "localhost"
    "127\.0\.0\.1"
    ":80[0-9][0-9]"
    "http://.*:80"
    "https://.*:80"
)

VIOLATIONS_FOUND=false

for pattern in "${PATTERNS[@]}"; do
    # Search in staged files only
    if git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx)$' | xargs grep -l "$pattern" 2>/dev/null | grep -v -E '\.env|\.githooks|node_modules'; then
        echo -e "${RED}❌ Found hardcoded URL pattern: $pattern${NC}"
        echo -e "${YELLOW}Files containing hardcoded URLs:${NC}"
        
        git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx)$' | xargs grep -n "$pattern" 2>/dev/null | grep -v -E '\.env|\.githooks|node_modules'
        
        VIOLATIONS_FOUND=true
    fi
done

if [ "$VIOLATIONS_FOUND" = true ]; then
    echo -e "\n${RED}🚫 Commit blocked!${NC}"
    echo -e "${YELLOW}Please use the centralized API configuration instead:${NC}"
    echo -e "  ✅ import { api, apiGet, apiPost } from '../lib/api';"
    echo -e "  ✅ const response = await apiGet('/your-endpoint');"
    echo -e "  ✅ Set VITE_API_URL environment variable for production"
    echo -e "\n${YELLOW}Allowed patterns:${NC}"
    echo -e "  ✅ Environment variables in .env* files"
    echo -e "  ✅ Comments and documentation"
    echo -e "  ✅ Using import.meta.env.VITE_API_URL"
    exit 1
fi

echo "✅ No hardcoded localhost URLs found"
exit 0
